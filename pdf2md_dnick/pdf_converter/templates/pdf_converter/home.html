<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>PDF → Text/Markdown Editor</title>

    <style>
        :root {
            --bg: #0b0f19;
            --border: rgba(255, 255, 255, .12);
            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .65);
            --primary: #5b8cff;
            --danger: #ff5a6a;
            --ok: #43d17a;
            --shadow: 0 10px 30px rgba(0, 0, 0, .35);
            --radius: 14px;

            --selectBg: rgba(12, 16, 28, .98);
            --selectBorder: rgba(255, 255, 255, .16);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1000px 600px at 10% -10%, rgba(91, 140, 255, .18), transparent 60%),
            radial-gradient(900px 500px at 90% 10%, rgba(67, 209, 122, .14), transparent 55%),
            var(--bg);
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 26px auto;
            padding: 0 18px 28px;
        }

        h1 {
            margin: 0 0 6px;
            font-size: 30px;
        }

        .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
            max-width: 820px;
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(10, 14, 26, .82);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            margin: 16px 0;
            box-shadow: var(--shadow);
        }

        .toolbarTop {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            line-height: 1;
            white-space: nowrap;
        }

        .btnPrimary {
            background: rgba(91, 140, 255, .22);
            border-color: rgba(91, 140, 255, .45);
        }

        .btnDanger {
            background: rgba(255, 90, 106, .18);
            border-color: rgba(255, 90, 106, .45);
        }

        .btn:disabled {
            opacity: .55;
            cursor: not-allowed;
        }

        .filePill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            font-size: 12px;
            color: var(--muted);
            max-width: 320px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .35);
            flex-shrink: 0;
        }

        .dot.ok {
            background: var(--ok);
        }

        .dot.bad {
            background: var(--danger);
        }

        .spacer {
            flex: 1;
        }

        .statusLine {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            min-height: 20px;
            font-size: 13px;
            color: var(--muted);
            flex-wrap: wrap;
        }

        .error {
            color: var(--danger);
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .panel {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
        }

        textarea {
            width: 100%;
            min-height: 520px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .03);
            color: var(--text);
            padding: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 13px;
            resize: vertical;
        }

        .preview {
            min-height: 520px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .03);
            padding: 14px;
            overflow: auto;
        }

        /* Select styling */
        select.btn {
            appearance: none;
            padding-right: 34px;
            background-color: var(--selectBg);
            border-color: var(--selectBorder);
            color: var(--text);

            background-image: linear-gradient(45deg, transparent 50%, rgba(255, 255, 255, .75) 50%),
            linear-gradient(135deg, rgba(255, 255, 255, .75) 50%, transparent 50%);
            background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        select.btn option {
            background: var(--selectBg);
            color: #fff;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }

            textarea, .preview {
                min-height: 360px;
            }

            .filePill {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>PDF → Text/Markdown Editor</h1>
    <p class="subtitle">
        Upload a PDF, choose a model, convert to text/markdown, edit it, see a live preview, and download.
    </p>

    <div class="toolbar">
        <div class="toolbarTop">
            <input id="pdfInput" type="file" accept="application/pdf" hidden/>

            <button id="chooseFileBtn" class="btn" type="button">Choose PDF</button>

            <span id="filePill" class="filePill" title="No file selected">
                <span id="fileDot" class="dot"></span>
                <span id="fileName">No file selected</span>
            </span>

            <!-- Model dropdown -->
            <select id="modelSelect" class="btn" title="Choose model" aria-label="Choose model">
                <option value="">Loading models…</option>
            </select>

            <button id="uploadBtn" class="btn btnPrimary" type="button">Upload & Convert</button>

            <button id="clearBtn" class="btn btnDanger" type="button">Clear</button>

            <div class="spacer"></div>

            <form action="/download/" method="POST">
                {% csrf_token %}
                <input type="hidden" name="text" id="downloadText"/>
                <input type="hidden" name="filename" value="output.txt"/>
                <button id="downloadBtn" class="btn" type="submit" disabled>Download .txt</button>
            </form>
        </div>

        <div class="statusLine">
            <span id="status"></span>
            <span id="err" class="error"></span>
        </div>
    </div>

    <div class="grid">
        <div class="panel">
            <h3>Markdown / Text</h3>
            <textarea id="mdEditor" placeholder="Upload a PDF to generate output..."></textarea>
        </div>

        <div class="panel">
            <h3>Preview</h3>
            <div id="preview" class="preview"></div>
        </div>
    </div>
</div>

<script>
    const pdfInput = document.getElementById("pdfInput");
    const chooseFileBtn = document.getElementById("chooseFileBtn");
    const fileNameEl = document.getElementById("fileName");
    const fileDot = document.getElementById("fileDot");

    const modelSelect = document.getElementById("modelSelect");

    const uploadBtn = document.getElementById("uploadBtn");
    const clearBtn = document.getElementById("clearBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    const mdEditor = document.getElementById("mdEditor");
    const preview = document.getElementById("preview");
    const statusEl = document.getElementById("status");
    const errEl = document.getElementById("err");
    const downloadText = document.getElementById("downloadText");

    function csrfToken() {
        const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
        return el ? el.value : "";
    }

    function setStatus(m) {
        statusEl.textContent = m || "";
    }

    function setError(m) {
        errEl.textContent = m || "";
    }

    function resetFileUI() {
        pdfInput.value = "";
        fileNameEl.textContent = "No file selected";
        document.getElementById("filePill").title = "No file selected";
        fileDot.className = "dot";
        chooseFileBtn.textContent = "Choose PDF";
    }

    async function post(url, data) {
        const res = await fetch(url, {
            method: "POST",
            headers: {"X-CSRFToken": csrfToken()},
            body: data
        });
        return {ok: res.ok, json: await res.json()};
    }

    async function loadModels() {
        try {
            const res = await fetch("/ocr-models/");
            const json = await res.json();
            const models = json.models || [];

            modelSelect.innerHTML = "";

            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = models.length ? "Select model…" : "No models available";
            modelSelect.appendChild(placeholder);

            for (const m of models) {
                const opt = document.createElement("option");
                opt.value = m.key;
                opt.textContent = m.label;
                modelSelect.appendChild(opt);
            }
        } catch (e) {
            modelSelect.innerHTML = `<option value="">Failed to load models</option>`;
        }
    }

    chooseFileBtn.addEventListener("click", () => pdfInput.click());

    pdfInput.addEventListener("change", () => {
        if (pdfInput.files && pdfInput.files.length > 0) {
            const name = pdfInput.files[0].name;
            fileNameEl.textContent = name;
            document.getElementById("filePill").title = name;
            fileDot.className = "dot ok";
            chooseFileBtn.textContent = "Change PDF";
            setStatus("");
            setError("");
        } else {
            resetFileUI();
        }
    });

    let renderTimer = null;

    async function renderPreview() {
        const fd = new FormData();
        fd.append("text", mdEditor.value);
        const {ok, json} = await post("/render/", fd);
        if (ok) preview.innerHTML = json.preview_html || "";
    }

    mdEditor.addEventListener("input", () => {
        downloadText.value = mdEditor.value;
        downloadBtn.disabled = mdEditor.value.trim().length === 0;

        if (renderTimer) clearTimeout(renderTimer);
        renderTimer = setTimeout(renderPreview, 220);
    });

    clearBtn.addEventListener("click", () => {
        mdEditor.value = "";
        preview.innerHTML = "";
        downloadText.value = "";
        downloadBtn.disabled = true;

        resetFileUI();

        setStatus("Cleared.");
        setError("");
    });

    uploadBtn.addEventListener("click", async () => {
        setError("");
        setStatus("");

        if (!pdfInput.files || !pdfInput.files.length) {
            setError("Please choose a PDF first.");
            fileDot.className = "dot bad";
            return;
        }

        if (!modelSelect.value) {
            setError("Please select a model first.");
            return;
        }

        uploadBtn.disabled = true;
        setStatus("Converting…");

        const fd = new FormData();
        fd.append("pdf", pdfInput.files[0]);
        fd.append("model_key", modelSelect.value);

        const {ok, json} = await post("/convert/", fd);
        uploadBtn.disabled = false;

        if (!ok) {
            setError(json.error || "Conversion failed.");
            fileDot.className = "dot bad";
            return;
        }

        mdEditor.value = json.markdown || "";
        preview.innerHTML = json.preview_html || "";
        downloadText.value = mdEditor.value;
        downloadBtn.disabled = mdEditor.value.trim().length === 0;

        const label = modelSelect.options[modelSelect.selectedIndex]?.textContent || "model";
        setStatus(`Done. Output generated using ${label}.`);
        fileDot.className = "dot ok";
    });

    // init
    resetFileUI();
    loadModels();
</script>
</body>
</html>
